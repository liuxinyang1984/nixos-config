1. ç›®å½•ç»“æ„
nixos-config/
â”œâ”€â”€ flake.nix
â”œâ”€â”€ hosts/
â”‚   â””â”€â”€ NixOS/
â”‚       â””â”€â”€ configuration.nix
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ programs/
â”‚   â”‚   â””â”€â”€ neovim/
â”‚   â”‚       â”œâ”€â”€ autoload/
â”‚   â”‚       â”‚   â””â”€â”€ plug.vim
â”‚   â”‚       â”œâ”€â”€ init.vim
â”‚   â”‚       â””â”€â”€ neovim.nix
â”‚   â”œâ”€â”€ desktop/
â”‚   â”‚   â””â”€â”€ hyprland/
â”‚   â”‚       â”œâ”€â”€ fonts.conf
â”‚   â”‚       â”œâ”€â”€ fonts.nix
â”‚   â”‚       â”œâ”€â”€ hyprland.nix
â”‚   â”‚       â””â”€â”€ input_method.nix
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ nginx.nix
â”‚   â”‚   â”œâ”€â”€ php.nix
â”‚   â”‚   â”œâ”€â”€ mariadb.nix
â”‚   â”‚   â”œâ”€â”€ redis.nix
â”‚   â”‚   â””â”€â”€ rabbitmq.nix
â”‚   â”œâ”€â”€ system/
â”‚   â”‚   â”œâ”€â”€ hardware.nix
â”‚   â”‚   â”œâ”€â”€ systemd.nix
â”‚   â”‚   â””â”€â”€ timezone.nix
â”‚   â””â”€â”€ ...
â””â”€â”€ home/
    â””â”€â”€ cookie/
        â”œâ”€â”€ home.nix

2. flake.nixå†…å®¹
{
  description = "My NixOS Configuration";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-23.11";
    flake-utils.url = "github:numtide/flake-utils";

    # ğŸ‘‡ å¼•å…¥ home-manager
    home-manager.url = "github:nix-community/home-manager";
    home-manager.inputs.nixpkgs.follows = "nixpkgs";
  };

  outputs = { self, nixpkgs, flake-utils, home-manager, ... }:
    flake-utils.lib.eachSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.${system};

        # é€’å½’åˆ—å‡ºæ‰€æœ‰ modules ä¸‹çš„ .nix æ–‡ä»¶
        listNixFiles = dir: let
          entries = builtins.attrNames (builtins.readDir dir);
          files = builtins.filter (f: builtins.match "\\.nix$" f != null) entries;
          dirs = builtins.filter (f: builtins.pathType (dir + "/" + f) == "directory") entries;
        in
          (map (f: dir + "/" + f) files)
          ++ builtins.concatLists (map (d: listNixFiles (dir + "/" + d)) dirs);

        modules = [
          # å¼•å…¥ä¸»æœºé…ç½®
          ./hosts/NixOS/configuration.nix

          # ğŸ‘‡ å¼•å…¥ home-manager çš„ NixOS æ¨¡å—
          home-manager.nixosModules.home-manager
        ] ++ listNixFiles ./modules;

      in {
        nixosConfigurations.NixOS = pkgs.lib.nixosSystem {
          system = system;
          modules = modules;
        };
      }
    );
}

3. hosts/NixOS/configuration.nix 
{ config, lib, pkgs, ... }:

{
  # è‡ªåŠ¨åŠ è½½ modules ä¸‹çš„æ‰€æœ‰æ¨¡å—ï¼Œflake.nix ä¸­å·²å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨ imports
  # å¦‚æœè¦æ·»åŠ  home-manager çš„é…ç½®ï¼Œåœ¨è¿™é‡Œå¼•å…¥ home.nix

  imports = [
    # ä½ çš„ç”¨æˆ· home-manager é…ç½®è·¯å¾„
    ../../home/cookie/home.nix
  ];

  # å¯ç”¨ nix flakes å’Œ nix-command
  nix = {
    settings.experimental-features = [ "nix-command" "flakes" ];
    registry.nixpkgs.flake = pkgs;
  };

  # å…è®¸éè‡ªç”±è½¯ä»¶
  nixpkgs.config.allowUnfree = true;

  # æŒ‡å®šç³»ç»Ÿç‰ˆæœ¬
  system.stateVersion = "23.11";
}

4. home/cookie/home.nix
{ config, pkgs, ... }:

let
  neovimCfg = import ../../modules/programs/neovim/neovim.nix { inherit config pkgs; };
in {
  home.username = "cookie";
  home.homeDirectory = "/home/cookie";

  programs.home-manager.enable = true;

  # åˆå¹¶ neovim é…ç½®
  programs.neovim = neovimCfg.programs.neovim;

  home.file = neovimCfg.home.file;

  home.stateVersion = "23.11";
}




